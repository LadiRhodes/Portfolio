(function(){var e,n,t,o,r,s,i,u,a,c,l;u=require("express"),o=require("body-parser"),n=require("basic-auth"),r=require("compression"),l=require("tingodb")().Db,i=require("child_process").exec,c=80|process.env.npm_package_config_port,e=u(),e.listen(c),console.log("starting on "+c),s=new l("./data",{nativeObjectID:!0}),a=s.collection("messages"),t=function(e,t,o){var r,s;return r=function(e){return e.set("WWW-Authenticate","Basic realm=Authentification requise"),e.sendStatus(401)},s=n(e),s&&s.name&&s.pass||r(t),"miton"===s.name&&"notim"===s.pass?o():r(t)},e.use(o.urlencoded({extended:!0})),e.use(o.json()),e.use(r()),e.use("/",u["static"](__dirname+"/build")),e.post("/update",function(e,n){var t,o,r,s;if(e.body.ref){s=e.body.ref,r="";try{i("git pull origin V3",function(e,n,t){e&&(r+=e),n&&(r+=n),t&&(r+=t)})}catch(o){t=o,r+=t}n.send("Update to: "+s+" "+r)}}),e.get("/messages",t,function(e,n){return a.find({}).toArray(function(e,t){return e||n.json(t),n.json(e)})}),e.post("/messages",function(e,n){var t,o,r,s;return null!=e.body.email&&(o=e.body.email),null!=e.body.content&&(t=e.body.content),null!=e.body.name&&(r=e.body.name),null==o||null==t||null==r?void n.json({error:"bad request"}):(s=/^[0-9a-z._-]+@{1}[0-9a-z.-]{2,}[.]{1}[a-z]{2,5}$/i,s.test(o)?a.insert({email:o,content:t,time:Date.now()},function(e,t){return null!=e?n.json({error:e}):n.json({id:t[0]._id})}):void n.json({error:"bad email"}))}),e["delete"]("/messages",function(e,n){return a.remove({},function(e,t){return null!=e?n.json({error:e}):n.json(t)})}),process.on("uncaughtException",function(e){console.log("Caught exception: "+e)})}).call(this);
